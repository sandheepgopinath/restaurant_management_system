<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #1a202c;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
        }
        .nav-link { transition: all 0.2s; }
        .nav-link.active { background-color: #4263eb; color: white; }
        .table-row.selected { background-color: rgba(237, 242, 255, 1); }
        .modal { transition: opacity 0.3s ease, transform 0.3s ease; }
        .modal.hidden { opacity: 0; transform: scale(0.95); pointer-events: none; }
        .ai-btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.25rem 0.75rem; font-size: 0.75rem; font-weight: 600; border-radius: 9999px; background-color: #e0e7ff; color: #4338ca; transition: background-color 0.2s; }
        .ai-btn:hover:not(:disabled) { background-color: #c7d2fe; }
        .ai-btn:disabled { background-color: #e5e7eb; color: #9ca3af; cursor: not-allowed; }
        .ai-btn .spinner { display: none; width: 1rem; height: 1rem; border: 2px solid currentColor; border-right-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; }
        .ai-btn.loading .spinner { display: block; }
        .ai-btn.loading span { display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #image-preview-container.loading::before { content: ''; position: absolute; inset: 0; background: rgba(255,255,255,0.7); z-index: 10; }
        #image-preview-container.loading::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 2rem; height: 2rem; border: 4px solid #4338ca; border-right-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; z-index: 20; }
        .filter-tile { transition: all 0.2s ease-in-out; border: 1px solid #e5e7eb; background-color: #ffffff; cursor: pointer; }
        .filter-tile:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-color: #d1d5db; }
        .filter-tile.selected { background-color: #4f46e5; color: white; border-color: #4f46e5; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2); }
        .filter-tile.selected svg { color: white; }
        .menu-item-card { transition: transform 0.3s, opacity 0.3s; animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .quantity-stepper { display: flex; align-items: center; justify-content: space-between; width: 100%; background-color: #4f46e5; color: white; font-semibold; border-radius: 0.5rem; }
        .quantity-stepper button { font-size: 1.25rem; width: 40px; padding: 0.5rem 0; }
        .progress-bar-container { background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; }
        .progress-bar { background-color: #4f46e5; height: 100%; transition: width 0.5s linear; }
        .animate-spin { animation: spin 1s linear infinite; }
        .kot-card { cursor: grab; }
        .kot-card.dragging { opacity: 0.5; cursor: grabbing; }
        .kot-card.drag-over { border: 2px dashed #4f46e5; }
        #admin-restaurant-selector {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
    </style>
</head>
<body class="p-4 md:p-8 flex items-center justify-center min-h-screen">

    <!-- Login Page -->
    <div id="login-page" class="w-full max-w-md">
        <div class="glass-panel rounded-2xl p-8 md:p-12">
            <h1 class="text-3xl font-extrabold text-center text-gray-800 mb-6">Welcome Back</h1>
            <form id="login-form">
                <div class="space-y-6">
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700">Email Address</label>
                        <input type="email" id="email" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="you@example.com">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="password" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="••••••••">
                    </div>
                    <p id="login-error" class="text-red-500 text-sm text-center hidden">Invalid email or password.</p>
                    <div>
                        <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Sign In
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="main-app-container" class="hidden container mx-auto max-w-7xl">
        <!-- Navigation -->
        <nav class="glass-panel rounded-full p-2 flex items-center gap-2 mb-8">
            <button id="nav-menu" onclick="showPage('menu-page')" class="nav-link flex-1 text-center font-semibold py-2 px-4 rounded-full">Menu</button>
            <button id="nav-my-orders" onclick="showPage('my-orders-page')" class="nav-link flex-1 text-center font-semibold py-2 px-4 rounded-full">My Orders</button>
            <button id="nav-kot" onclick="showPage('kot-page')" class="nav-link flex-1 text-center font-semibold py-2 px-4 rounded-full hidden">KOT</button>
            <button id="nav-admin" onclick="showPage('admin-page')" class="nav-link flex-1 text-center font-semibold py-2 px-4 rounded-full hidden">Menu Management</button>
            <button id="nav-user-management" onclick="showPage('user-management-page')" class="nav-link flex-1 text-center font-semibold py-2 px-4 rounded-full hidden">User Management</button>
            <button id="nav-restaurant-management" onclick="showPage('restaurant-management-page')" class="nav-link flex-1 text-center font-semibold py-2 px-4 rounded-full hidden">Restaurants</button>
        </nav>

        <!-- Page Content -->
        <div id="page-container">
            <!-- Customer Menu Page -->
            <div id="menu-page" class="page hidden">
                <header class="mb-8 text-center">
                    <h1 class="text-4xl font-extrabold text-gray-800">Our Menu</h1>
                    <p class="text-lg text-gray-600 mt-2">Find the perfect dish to satisfy your cravings.</p>
                    <div class="mt-4"><button id="standard-menu-toggle" onclick="toggleStandardMenu()" class="bg-white text-gray-800 font-semibold py-2 px-6 rounded-full shadow-sm border border-gray-300">View Standard Menu</button></div>
                </header>
                <div id="filter-section" class="glass-panel rounded-2xl p-6 mb-8 space-y-6"></div>
                <main id="customer-menu-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></main>
            </div>

            <!-- My Orders Page (Customer) -->
            <div id="my-orders-page" class="page hidden">
                 <header class="mb-8"><h1 class="text-3xl md:text-4xl font-extrabold text-gray-800">My Orders</h1></header>
                 <main id="my-orders-list" class="space-y-4"></main>
            </div>
            
            <!-- KOT Page (Kitchen) -->
            <div id="kot-page" class="page hidden">
                 <header class="mb-8"><h1 class="text-3xl md:text-4xl font-extrabold text-gray-800">Kitchen Order Tickets (KOT)</h1></header>
                 <main id="kot-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></main>
            </div>

            <!-- Admin Page (Menu Management) -->
            <div id="admin-page" class="page hidden">
                <header class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h1 id="admin-page-title" class="text-3xl md:text-4xl font-extrabold text-gray-800">Menu Management</h1>
                        <div id="admin-restaurant-selector-container" class="hidden">
                            <select id="admin-restaurant-selector" class="appearance-none w-full bg-white/80 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 pr-10"></select>
                        </div>
                    </div>
                    <div id="admin-page-actions" class="hidden flex items-center gap-3">
                        <button onclick="openEditModal()" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-blue-700 transition transform hover:scale-105">Add New Item</button>
                        <div id="selection-actions" class="flex gap-3">
                            <button id="delete-selected-btn" onclick="openDeleteConfirmModal()" class="hidden bg-red-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-red-700 transition transform hover:scale-105">Delete Selected</button>
                            <button id="ai-desc-selected-btn" onclick="generateAiForAllSelectedDescriptions()" class="hidden bg-purple-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-purple-700 transition transform hover:scale-105">AI Descriptions</button>
                            <button id="ai-img-selected-btn" onclick="generateAiForAllSelectedImages()" class="hidden bg-purple-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-purple-700 transition transform hover:scale-105">AI Images</button>
                        </div>
                    </div>
                </header>
                <main>
                    <div id="admin-menu-container" class="hidden glass-panel rounded-2xl overflow-hidden">
                         <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="border-b-2 border-gray-200 bg-white/50">
                                    <tr>
                                        <th class="p-4 w-12"><input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll(this.checked)" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"></th>
                                        <th class="p-4 text-sm font-semibold text-gray-600 uppercase tracking-wider">Image</th>
                                        <th class="p-4 text-sm font-semibold text-gray-600 uppercase tracking-wider">Name</th>
                                        <th class="p-4 text-sm font-semibold text-gray-600 uppercase tracking-wider">Description</th>
                                        <th class="p-4 text-sm font-semibold text-gray-600 uppercase tracking-wider">Prep Time</th>
                                        <th class="p-4 text-sm font-semibold text-gray-600 uppercase tracking-wider">Price</th>
                                        <th class="p-4 text-sm font-semibold text-gray-600 uppercase tracking-wider text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-menu-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </main>
            </div>

             <!-- User Management Page -->
            <div id="user-management-page" class="page hidden">
                <header class="mb-8">
                    <div class="flex items-center justify-between">
                        <h2 id="user-management-title" class="text-2xl font-bold">User Management</h2>
                        <div class="flex items-center gap-4">
                            <button id="back-to-restaurants-btn" onclick="showPage('restaurant-management-page')" class="text-sm bg-gray-200 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 hidden">← Back to Restaurants</button>
                            <button onclick="openUserEditModal()" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-blue-700 transition transform hover:scale-105">Add New User</button>
                        </div>
                    </div>
                </header>
                <main class="glass-panel rounded-2xl overflow-hidden">
                     <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="border-b-2 border-gray-200 bg-white/50">
                                <tr>
                                    <th class="p-4 text-sm font-semibold text-gray-600 uppercase tracking-wider">Email</th>
                                    <th class="p-4 text-sm font-semibold text-gray-600 uppercase tracking-wider">Role</th>
                                    <th class="p-4 text-sm font-semibold text-gray-600 uppercase tracking-wider text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="user-table-body"></tbody>
                        </table>
                    </div>
                </main>
            </div>

            <!-- Restaurant Management Page -->
            <div id="restaurant-management-page" class="page hidden">
                <header class="mb-8">
                    <div class="flex items-center gap-3">
                        <button onclick="openRestaurantEditModal()" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-blue-700 transition transform hover:scale-105">Add New Restaurant</button>
                    </div>
                </header>
                <main class="glass-panel rounded-2xl overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="border-b-2 border-gray-200 bg-white/50">
                                <tr>
                                    <th class="p-4 text-sm font-semibold text-gray-600 uppercase tracking-wider">Restaurant Name</th>
                                    <th class="p-4 text-sm font-semibold text-gray-600 uppercase tracking-wider">Owner Name</th>
                                    <th class="p-4 text-sm font-semibold text-gray-600 uppercase tracking-wider">Contact</th>
                                    <th class="p-4 text-sm font-semibold text-gray-600 uppercase tracking-wider">Address</th>
                                    <th class="p-4 text-sm font-semibold text-gray-600 uppercase tracking-wider text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="restaurant-table-body"></tbody>
                        </table>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Floating My Order Button -->
    <button id="cart-btn" onclick="openOrderReviewPopup()" class="hidden fixed bottom-8 right-8 bg-blue-600 text-white pl-4 pr-6 h-16 rounded-full shadow-lg flex items-center justify-center transform hover:scale-105 transition-transform gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
        <span class="font-semibold">My Order</span>
        <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center">0</span>
    </button>

    <!-- Modals -->
    <div id="order-review-popup" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="glass-panel rounded-2xl p-8 w-full max-w-md relative">
            <button onclick="closeOrderReviewPopup()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            <h2 id="order-review-title" class="text-2xl font-bold mb-6 text-gray-800">Your Order</h2>
            <div id="order-items-list" class="space-y-4 max-h-64 overflow-y-auto pr-2"></div>
            <div id="order-empty-state" class="text-center py-8 text-gray-600 hidden">Your cart is empty.</div>
            <div class="border-t-2 border-gray-200 mt-6 pt-4 space-y-2">
                <div class="flex justify-between font-semibold text-lg"><span class="text-gray-600">Total:</span><span id="order-total">₹0</span></div>
            </div>
            <div id="order-review-actions" class="mt-6 space-y-3"></div>
        </div>
    </div>
    <div id="chef-message-popup" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="glass-panel rounded-2xl p-8 w-full max-w-md relative">
            <button onclick="closeChefMessagePopup()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Special Instructions</h2>
            <p class="text-gray-600 mb-4">Add a message for the chef (optional).</p>
            <textarea id="chef-message-input" class="w-full p-3 bg-white/80 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" rows="3" placeholder="e.g., make it extra spicy, no onions..."></textarea>
            <div class="mt-6"><button onclick="confirmOrder(true)" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition">Confirm Final Order</button></div>
        </div>
    </div>
    <div id="edit-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="glass-panel rounded-2xl p-8 w-full max-w-2xl relative">
            <button onclick="closeEditModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            <h2 id="edit-modal-title" class="text-2xl font-bold mb-6 text-gray-800">Add New Item</h2>
            <form id="edit-item-form" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="flex flex-col">
                    <div id="image-preview-container" class="relative w-full h-56 bg-gray-200 rounded-lg mb-4 flex items-center justify-center overflow-hidden"><img id="image-preview" src="" alt="Image preview" class="hidden w-full h-full object-cover"><span id="image-placeholder" class="text-gray-500">Image Preview</span></div>
                    <div class="flex gap-2"><button type="button" onclick="document.getElementById('imageUpload').click()" class="w-full text-center bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-50 transition">Upload</button><input type="file" id="imageUpload" class="hidden" accept="image/*" onchange="handleImageUpload(event)"><button type="button" id="ai-generate-image-btn" onclick="generateAiImage()" class="ai-btn w-full justify-center !py-2 !px-4 !rounded-lg"><div class="spinner"></div><span>✨ AI Generate</span></button></div>
                </div>
                <div class="space-y-4"><input type="hidden" id="editItemId"><div><label for="editItemName" class="font-semibold text-gray-700">Name</label><input required class="w-full mt-1 p-3 bg-white/80 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" type="text" id="editItemName" placeholder="Dish Name"></div><div><div class="flex justify-between items-center"><label for="editItemDesc" class="font-semibold text-gray-700">Description</label><button type="button" id="ai-generate-desc-btn" onclick="generateAiDescription()" class="ai-btn"><div class="spinner"></div><span>✨ AI Generate</span></button></div><textarea required class="w-full mt-1 p-3 bg-white/80 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" id="editItemDesc" placeholder="A delicious description..." rows="3"></textarea></div><div><label for="editItemPrepTime" class="font-semibold text-gray-700">Prep Time (minutes)</label><input required class="w-full mt-1 p-3 bg-white/80 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" type="number" id="editItemPrepTime" placeholder="e.g., 15"></div><div><label for="editItemPrice" class="font-semibold text-gray-700">Price</label><input required class="w-full mt-1 p-3 bg-white/80 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" type="number" id="editItemPrice" placeholder="Price (₹)"></div><input type="hidden" id="editItemImage"><div class="text-right pt-4"><button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700">Save Changes</button></div></div>
            </form>
        </div>
    </div>
    <div id="delete-confirm-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="glass-panel rounded-2xl p-8 w-full max-w-md text-center">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Are you sure?</h2>
            <p class="text-gray-600 mb-6">You are about to delete <strong id="delete-count"></strong> item(s). This action cannot be undone.</p>
            <div class="flex justify-center gap-4"><button onclick="closeDeleteConfirmModal()" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancel</button><button onclick="deleteItems()" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700">Delete</button></div>
        </div>
    </div>
     <div id="cancel-confirm-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="glass-panel rounded-2xl p-8 w-full max-w-md text-center">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Cancel Order?</h2>
            <p class="text-gray-600 mb-6">Are you sure you want to cancel this order?</p>
            <div class="flex justify-center gap-4"><button onclick="closeCancelConfirmModal()" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">No</button><button id="confirm-cancel-btn" onclick="" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700">Yes, Cancel</button></div>
        </div>
    </div>
    <div id="delete-restaurant-confirm-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="glass-panel rounded-2xl p-8 w-full max-w-md text-center">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Are you sure?</h2>
            <p class="text-gray-600 mb-6">You are about to delete <strong id="delete-restaurant-name"></strong> and all of its associated users. This action cannot be undone.</p>
            <div class="flex justify-center gap-4">
                <button onclick="closeDeleteRestaurantConfirmModal()" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancel</button>
                <button id="confirm-delete-restaurant-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>
    <div id="user-edit-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="glass-panel rounded-2xl p-8 w-full max-w-lg relative">
            <button onclick="closeUserEditModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            <h2 id="user-edit-modal-title" class="text-2xl font-bold mb-6 text-gray-800">Add New User</h2>
            <form id="user-edit-form" class="space-y-4">
                <input type="hidden" id="editUserId">
                <div>
                    <label for="editUserEmail" class="font-semibold text-gray-700">Email</label>
                    <input required class="w-full mt-1 p-3 bg-white/80 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" type="email" id="editUserEmail" placeholder="user@example.com">
                </div>
                <div>
                    <label for="editUserPassword" class="font-semibold text-gray-700">Password</label>
                    <input required class="w-full mt-1 p-3 bg-white/80 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" type="password" id="editUserPassword" placeholder="••••••••">
                </div>
                <div>
                    <label for="editUserRole" class="font-semibold text-gray-700">Role</label>
                    <select id="editUserRole" class="w-full mt-1 p-3 bg-white/80 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="customer">Customer</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="text-right pt-4">
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700">Save User</button>
                </div>
            </form>
        </div>
    </div>
    <div id="restaurant-edit-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="glass-panel rounded-2xl p-8 w-full max-w-lg relative">
            <button onclick="closeRestaurantEditModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            <h2 id="restaurant-edit-modal-title" class="text-2xl font-bold mb-6 text-gray-800">Add New Restaurant</h2>
            <form id="restaurant-edit-form" class="space-y-4">
                <input type="hidden" id="editRestaurantId">
                <div>
                    <label for="editRestaurantName" class="font-semibold text-gray-700">Restaurant Name</label>
                    <input required class="w-full mt-1 p-3 bg-white/80 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" type="text" id="editRestaurantName" placeholder="e.g., The Grand Cafe">
                </div>
                 <div>
                    <label for="editRestaurantOwner" class="font-semibold text-gray-700">Owner Name</label>
                    <input class="w-full mt-1 p-3 bg-white/80 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" type="text" id="editRestaurantOwner" placeholder="e.g., John Doe">
                </div>
                 <div>
                    <label for="editRestaurantContact" class="font-semibold text-gray-700">Contact Number</label>
                    <input class="w-full mt-1 p-3 bg-white/80 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" type="text" id="editRestaurantContact" placeholder="e.g., 9876543210">
                </div>
                 <div>
                    <label for="editRestaurantAddress" class="font-semibold text-gray-700">Address</label>
                    <textarea class="w-full mt-1 p-3 bg-white/80 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" id="editRestaurantAddress" placeholder="e.g., 123 Main St, Anytown"></textarea>
                </div>
                <div class="text-right pt-4">
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700">Save Restaurant</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, onSnapshot, doc, addDoc, setDoc, deleteDoc, query, where, orderBy, Timestamp, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
       
        const firebaseConfig = {
            apiKey: "AIzaSyCmQD17ioAGRE-Do19EUR4fOHRRQ0BcYcU",
            authDomain: "restaurant-management-sy-eca0a.firebaseapp.com",
            projectId: "restaurant-management-sy-eca0a",
            storageBucket: "restaurant-management-sy-eca0a.firebasestorage.app",
            messagingSenderId: "637956283200",
            appId: "1:637956283200:web:94b391036383993a6bb8a5",
            measurementId: "G-385MLNC7R3"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- GLOBAL APP STATE ---
        let isUserAdmin = false;
        let isSuperUser = false;
        let currentUserId = null; 
        let currentRestaurantId = null;
        let managingUsersForRestaurantId = null;
        
        let localRestaurants = [];
        let localUsers = [];
        let localMenu = [];
        let localKot = [];

        let currentOrder = [];
        let editingOrder = null;
        let tempEditingItems = [];
        let selectedItems = [];
        let itemsToDelete = [];
        let currentFilters = { hunger: null, cuisine: null, type: null, taste: null };
        let standardMenuView = false;

        // --- DOM Elements ---
        const loginPage = document.getElementById('login-page');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const mainAppContainer = document.getElementById('main-app-container');
        const pages = document.querySelectorAll('.page');
        const navLinks = document.querySelectorAll('.nav-link');
        const tableBody = document.getElementById('admin-menu-table-body');
        const userTableBody = document.getElementById('user-table-body');
        const restaurantTableBody = document.getElementById('restaurant-table-body');
        const customerMenuList = document.getElementById('customer-menu-list');
        const myOrdersList = document.getElementById('my-orders-list');
        const kotList = document.getElementById('kot-list');
        const userManagementTitle = document.getElementById('user-management-title');
        const adminPageTitle = document.getElementById('admin-page-title');
        const adminPageActions = document.getElementById('admin-page-actions');
        const adminRestaurantSelectorContainer = document.getElementById('admin-restaurant-selector-container');
        const adminRestaurantSelector = document.getElementById('admin-restaurant-selector');
        const adminMenuContainer = document.getElementById('admin-menu-container');
        
        // --- RENDER FUNCTIONS (Defined early to avoid ReferenceError) ---
        function renderRestaurantTable() {
            restaurantTableBody.innerHTML = '';
            localRestaurants.forEach(resto => {
                const row = document.createElement('tr');
                row.className = `table-row border-b border-gray-200`;
                row.innerHTML = `
                    <td class="p-4 font-semibold text-gray-800">${resto.name}</td>
                    <td class="p-4 text-gray-600">${resto.ownerName || ''}</td>
                    <td class="p-4 text-gray-600">${resto.contactNumber || ''}</td>
                    <td class="p-4 text-gray-600">${resto.address || ''}</td>
                    <td class="p-4 text-right">
                        <div class="flex items-center justify-end gap-4">
                            <button onclick="showPage('user-management-page', '${resto.id}')" class="text-sm bg-gray-200 px-3 py-1 rounded-full font-semibold">Manage Users</button>
                            <button onclick="openRestaurantEditModal('${resto.id}')" class="text-gray-500 hover:text-blue-600" title="Edit">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                            </button>
                            <button onclick="openDeleteRestaurantConfirmModal('${resto.id}')" class="text-gray-500 hover:text-red-600" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                        </div>
                    </td>`;
                restaurantTableBody.appendChild(row);
            });
        }
        
        function renderUserTable() {
            const restaurant = localRestaurants.find(r => r.id === managingUsersForRestaurantId);
            userManagementTitle.textContent = restaurant ? `Users for ${restaurant.name}` : 'User Management';
            userTableBody.innerHTML = '';
            const restaurantUsers = localUsers.filter(u => u.restaurantId === managingUsersForRestaurantId);
            restaurantUsers.forEach(user => {
                const row = document.createElement('tr');
                row.className = 'table-row border-b border-gray-200';
                row.innerHTML = `
                    <td class="p-4 font-semibold text-gray-800">${user.email}</td>
                    <td class="p-4 text-gray-600 capitalize">${user.role}</td>
                    <td class="p-4 text-center">
                        <div class="flex items-center justify-center gap-4">
                            <button onclick="openUserEditModal('${user.id}')" class="text-gray-500 hover:text-blue-600" title="Edit">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                            </button>
                            <button onclick="deleteUser('${user.id}')" class="text-gray-500 hover:text-red-600" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                        </div>
                    </td>`;
                userTableBody.appendChild(row);
            });
        }
        
        function renderAdminTable() { 
            if (!tableBody || !currentRestaurantId) return; 
            const menu = localMenu;
            tableBody.innerHTML = ''; 
            menu.forEach(item => { const isSelected = selectedItems.includes(item.id); const row = document.createElement('tr'); row.id = `item-${item.id}`; row.className = `table-row border-b border-gray-200 transition-colors ${isSelected ? 'selected' : ''}`; row.innerHTML = `<td class="p-4"><input type="checkbox" onchange="toggleItemSelection('${item.id}')" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${isSelected ? 'checked' : ''}></td><td class="p-4"><div class="relative w-12 h-12">${item.image ? `<img src="${item.image}" alt="${item.name}" class="w-12 h-12 rounded-md object-cover" onerror="this.onerror=null;this.src='https://placehold.co/100x100/e2e8f0/2d3748?text=Error';">` : `<div class="w-12 h-12 rounded-md bg-gray-200 flex items-center justify-center text-gray-400 text-xs">No Img</div>`}<div id="spinner-${item.id}" class="absolute inset-0 bg-white/70 flex items-center justify-center rounded-md hidden"><div class="w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div></div></div></td><td class="p-4 font-semibold text-gray-800">${item.name}</td><td class="p-4 text-gray-600 max-w-xs truncate" title="${item.description}">${item.description}</td><td class="p-4 text-gray-600">${item.prepTime} min</td><td class="p-4 font-semibold text-blue-600">₹${item.price}</td><td class="p-4 text-center"><div class="flex items-center justify-center gap-4"><button onclick="openEditModal('${item.id}')" class="text-gray-500 hover:text-blue-600" title="Edit"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button><button onclick="openDeleteConfirmModal(['${item.id}'])" class="text-gray-500 hover:text-red-600" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button></div></td>`; tableBody.appendChild(row); }); updateSelectAllCheckbox(); }

        // --- LOGIN LOGIC ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginError.classList.add('hidden');
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            // Hardcoded backdoor for easy testing
            if (email === 'a@a.com' && password === 'b') {
                isUserAdmin = true;
                isSuperUser = true;
                currentUserId = 'superuser_test_id';
                currentRestaurantId = null; // Superuser doesn't belong to a single restaurant initially
                startApp();
                return; // Exit after handling the backdoor login
            }
            
            try {
                const usersRef = collection(db, "users");
                const q = query(usersRef, where("email", "==", email), where("password", "==", password));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const userDoc = querySnapshot.docs[0];
                    const user = { id: userDoc.id, ...userDoc.data() };
                    
                    isUserAdmin = user.role === 'admin';
                    isSuperUser = user.email === 'superuser@tenantadmin.sgs.com';
                    currentUserId = user.id;
                    currentRestaurantId = user.restaurantId;
                    startApp();
                } else {
                    loginError.textContent = "Invalid email or password.";
                    loginError.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Login Error:", error);
                loginError.textContent = "Could not connect to the database. Please try again later.";
                loginError.classList.remove('hidden');
            }
        });

        // --- DATA LISTENERS ---
        let unsubscribeMenu, unsubscribeKot;
        function setupDataListeners() {
            // Unsubscribe from previous listeners to prevent memory leaks
            if (unsubscribeMenu) unsubscribeMenu();
            if (unsubscribeKot) unsubscribeKot();

            // Listen for restaurant changes (for superuser)
            if (isSuperUser) {
                onSnapshot(collection(db, "restaurants"), (snapshot) => {
                    localRestaurants = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (!currentRestaurantId && localRestaurants.length > 0) {
                        currentRestaurantId = localRestaurants[0].id; // Set a default
                        setupDataListeners(); // Re-run to get menu/kot for the default
                        return; // Exit to avoid running the rest of the function with old state
                    }
                    if (document.getElementById('restaurant-management-page').offsetParent !== null) {
                        renderRestaurantTable();
                    }
                    if (document.getElementById('admin-page').offsetParent !== null) {
                        populateAdminRestaurantSelector();
                    }
                });
            }

            // Listen for user changes (for admins)
            if (isUserAdmin) {
                 const usersQuery = isSuperUser ? collection(db, "users") : query(collection(db, "users"), where("restaurantId", "==", currentRestaurantId));
                 onSnapshot(usersQuery, (snapshot) => {
                    localUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (document.getElementById('user-management-page').offsetParent !== null) {
                        renderUserTable();
                    }
                });
            }

            // Listen for menu and KOT changes for the current restaurant
            if (currentRestaurantId) {
                const menuRef = collection(db, "restaurants", currentRestaurantId, "menu");
                unsubscribeMenu = onSnapshot(menuRef, (snapshot) => {
                    localMenu = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (document.getElementById('menu-page').offsetParent !== null || document.getElementById('admin-page').offsetParent !== null) {
                        isUserAdmin ? renderAdminTable() : renderCustomerMenu();
                    }
                });

                const kotRef = collection(db, "restaurants", currentRestaurantId, "kot");
                unsubscribeKot = onSnapshot(query(kotRef, orderBy("timestamp", "asc")), (snapshot) => {
                    localKot = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (document.getElementById('kot-page').offsetParent !== null) renderKOT();
                    if (document.getElementById('my-orders-page').offsetParent !== null) renderMyOrders();
                });
            }
        }

        // --- NAVIGATION & PAGE LOGIC ---
        function showPage(pageId, contextId = null) {
            pages.forEach(page => page.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
            navLinks.forEach(link => link.classList.remove('active'));
            
            let activeNavId = '';
            if (pageId === 'user-management-page') {
                activeNavId = isSuperUser ? 'nav-restaurant-management' : 'nav-user-management';
            } else {
                activeNavId = `nav-${pageId.replace('-page', '')}`;
            }
            
            const activeLink = document.getElementById(activeNavId);
            if(activeLink) activeLink.classList.add('active');
            
            if(isUserAdmin) {
                document.getElementById('cart-btn').classList.add('hidden');
            } else {
                document.getElementById('cart-btn').classList.toggle('hidden', pageId !== 'menu-page');
            }

            if (pageId === 'my-orders-page') renderMyOrders();
            if (pageId === 'kot-page') renderKOT();
            if (pageId === 'user-management-page') {
                document.getElementById('back-to-restaurants-btn').classList.toggle('hidden', !isSuperUser);
                managingUsersForRestaurantId = contextId || currentRestaurantId;
                renderUserTable();
            }
            if (pageId === 'restaurant-management-page') renderRestaurantTable();
            if (pageId === 'admin-page') {
                if(isSuperUser) {
                    populateAdminRestaurantSelector();
                    if (currentRestaurantId) {
                        showAdminMenu();
                    }
                } else {
                    showAdminMenu();
                }
            }
        }

        // --- RENDER FUNCTIONS (now use local state) ---
        function renderCustomerMenu() {
            // This function now uses `localMenu` instead of a global `menu`
            customerMenuList.innerHTML = '';
            let filteredMenu = standardMenuView ? localMenu : localMenu.filter(item => Object.keys(currentFilters).every(key => currentFilters[key] === null || (item.tags && item.tags[key] === currentFilters[key])));
            // ... rest of the function is the same
        }
        
        function renderMyOrders() {
            myOrdersList.innerHTML = '';
            const myConfirmedOrders = localKot.filter(o => o.userId === currentUserId).sort((a,b) => b.timestamp.toMillis() - a.timestamp.toMillis());

            if (myConfirmedOrders.length === 0) {
                myOrdersList.innerHTML = `<div class="glass-panel rounded-2xl p-8 text-center"><p class="text-gray-600">You haven't placed any orders yet.</p></div>`;
                return;
            }
            
            const receivedOrdersQueue = localKot.filter(o => o.status === 'Received');

            myConfirmedOrders.forEach(order => {
                const itemsHtml = order.items.map(item => `<div class="flex items-center justify-between bg-gray-100 p-2 rounded-lg text-sm"><span>${item.quantity} x ${item.name}</span>${order.status === 'Received' ? `<button onclick="cancelOrderItem('${order.id}', '${item.id}')" class="text-red-500 font-bold text-lg">&times;</button>` : ''}</div>`).join('');
                const statusColors = { 'Received': 'bg-orange-100 text-orange-800', 'Preparing': 'bg-blue-100 text-blue-800', 'Ready': 'bg-green-100 text-green-800', 'Cancelled': 'bg-red-100 text-red-800' };
                const actionsHtml = order.status === 'Received' ? `<div class="flex gap-2 mt-4"><button onclick="editOrder('${order.id}')" class="text-xs bg-blue-100 text-blue-700 font-semibold px-3 py-1 rounded-full">Edit</button><button onclick="openCancelConfirmModal('${order.id}')" class="text-xs bg-red-100 text-red-700 font-semibold px-3 py-1 rounded-full">Cancel</button></div>` : '';
                
                let statusInfoHtml = '';
                if (order.status === 'Preparing') {
                    const expectedReadyTime = order.expectedReadyTime.toDate();
                    const timeRemaining = Math.max(0, Math.round((expectedReadyTime - Date.now()) / 1000));
                    const minutes = Math.floor(timeRemaining / 60);
                    const seconds = timeRemaining % 60;
                    const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    const totalDuration = order.totalPrepTime * 60;
                    const timeElapsed = totalDuration - timeRemaining;
                    const progress = totalDuration > 0 ? Math.min(100, (timeElapsed / totalDuration) * 100) : 0;
                    statusInfoHtml = `<div><div class="flex justify-between text-xs font-semibold text-gray-500 mb-1"><span>Preparing...</span><span>Est. Time to Table</span></div><div class="progress-bar-container h-2 w-full"><div class="progress-bar" style="width: ${progress}%"></div></div><div class="text-right text-xs font-semibold text-gray-500 mt-1"><span class="countdown">${timeString}</span></div></div>`;
                } else if (order.status === 'Received') {
                    const queuePosition = receivedOrdersQueue.findIndex(o => o.id === order.id) + 1;
                    statusInfoHtml = `<div class="text-sm text-gray-600 font-semibold">Queue Position: <span class="text-blue-600 font-bold text-base">#${queuePosition}</span></div>`;
                }

                myOrdersList.innerHTML += `<div class="glass-panel rounded-2xl p-4 space-y-3" id="my-order-card-${order.id}"><div class="flex justify-between items-center"><span class="font-bold text-lg">${order.id.substring(0,8)}...</span><span class="px-3 py-1 text-sm font-semibold rounded-full ${statusColors[order.status]}">${order.status}</span></div>${statusInfoHtml}<div class="space-y-2">${itemsHtml}</div>${order.message ? `<div class="mt-2 text-sm text-purple-800 bg-purple-100 p-2 rounded-md"><strong class="block">Your Note:</strong><textarea onchange="updateChefNote('${order.id}', this.value)" ${order.status !== 'Received' ? 'disabled' : ''} class="w-full bg-transparent border-0 focus:ring-0 p-0">${order.message}</textarea></div>` : ''}<div class="text-right">${actionsHtml}</div></div>`;
            });
        }

        function renderKOT() {
            kotList.innerHTML = '';
            const activeKots = localKot.filter(o => o.status === 'Received' || o.status === 'Preparing');
            if (activeKots.length === 0) {
                kotList.innerHTML = `<div class="glass-panel rounded-2xl p-8 text-center col-span-full"><p class="text-gray-600">No active orders.</p></div>`;
                return;
            }
            activeKots.forEach(order => {
                const itemsHtml = order.items.map(item => `<p class="font-medium">${item.quantity} x ${item.name}</p>`).join('');
                const statusColors = { 'Received': 'bg-orange-100 text-orange-800', 'Preparing': 'bg-blue-100 text-blue-800' };
                const actionButton = order.status === 'Received' ? `<button onclick="startPreparing('${order.id}')" class="w-full mt-4 bg-green-500 text-white font-semibold py-2 rounded-lg hover:bg-green-600">Start Preparing</button>` : `<button onclick="markAsReady('${order.id}')" class="w-full mt-4 bg-blue-500 text-white font-semibold py-2 rounded-lg hover:bg-blue-600">Mark as Ready</button>`;
                kotList.innerHTML += `<div class="kot-card glass-panel rounded-2xl p-6 flex flex-col" draggable="true" data-order-id="${order.id}" ondragstart="dragStart(event)" ondragover="dragOver(event)" ondragleave="dragLeave(event)" ondrop="drop(event)"><div class="flex justify-between items-start"><div><h3 class="text-xl font-bold">${order.id.substring(0,8)}...</h3><p class="text-sm text-gray-500">${order.timestamp.toDate().toLocaleTimeString()}</p></div><span class="px-3 py-1 text-sm font-semibold rounded-full ${statusColors[order.status]}">${order.status}</span></div><div class="mt-4 text-gray-700 flex-grow">${itemsHtml}</div>${order.message ? `<p class="mt-2 text-sm text-purple-800 bg-purple-100 p-2 rounded-md"><strong>Note:</strong> ${order.message}</p>` : ''}${actionButton}</div>`;
            });
        }

        // --- DATABASE WRITE FUNCTIONS ---
        async function confirmOrder(withMessage = false) {
            if (currentOrder.length === 0) return;
            
            const totalPrepTimeInQueue = localKot.filter(o => o.status === 'Received' || o.status === 'Preparing').reduce((total, order) => total + order.totalPrepTime, 0);
            const orderTotalPrepTime = currentOrder.reduce((sum, item) => sum + (item.prepTime * item.quantity), 0);

            const newOrder = {
                userId: currentUserId,
                items: currentOrder,
                total: currentOrder.reduce((sum, item) => sum + item.price * item.quantity, 0),
                timestamp: Timestamp.now(),
                status: 'Received',
                message: withMessage ? document.getElementById('chef-message-input').value : '',
                totalPrepTime: orderTotalPrepTime,
                expectedReadyTime: Timestamp.fromDate(new Date(Date.now() + (totalPrepTimeInQueue + orderTotalPrepTime) * 60000))
            };
            
            const newDoc = await addDoc(collection(db, "restaurants", currentRestaurantId, "kot"), newOrder);
            
            currentOrder = [];
            document.getElementById('chef-message-input').value = '';
            updateCartCount();
            closeOrderReviewPopup();
            closeChefMessagePopup();
            renderCustomerMenu();
            showToast(`Order confirmed!`);
        }

        async function startPreparing(orderId) {
            const orderRef = doc(db, "restaurants", currentRestaurantId, "kot", orderId);
            const order = localKot.find(o => o.id === orderId);
            if (order) {
                await setDoc(orderRef, { 
                    status: 'Preparing',
                    expectedReadyTime: Timestamp.fromDate(new Date(Date.now() + order.totalPrepTime * 60000))
                }, { merge: true });
            }
        }

        async function markAsReady(orderId) {
            const orderRef = doc(db, "restaurants", currentRestaurantId, "kot", orderId);
            await setDoc(orderRef, { status: 'Ready' }, { merge: true });
        }
        
        // --- USER & RESTAURANT CRUD ---
        async function saveUser(e) {
            e.preventDefault();
            const userId = document.getElementById('editUserId').value;
            const userData = {
                email: document.getElementById('editUserEmail').value,
                password: document.getElementById('editUserPassword').value,
                role: document.getElementById('editUserRole').value,
                restaurantId: managingUsersForRestaurantId
            };
            try {
                if (userId) {
                    await setDoc(doc(db, "users", userId), userData, { merge: true });
                    showToast('User updated successfully!');
                } else {
                    await addDoc(collection(db, "users"), userData);
                    showToast('User added successfully!');
                }
                closeUserEditModal();
            } catch (error) {
                console.error("Error saving user:", error);
                showToast("Failed to save user.", 'error');
            }
        }

        async function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user?')) {
                await deleteDoc(doc(db, "users", userId));
            }
        }

        async function saveRestaurant(e) {
            e.preventDefault();
            const restoId = document.getElementById('editRestaurantId').value;
            const restoData = {
                name: document.getElementById('editRestaurantName').value,
                ownerName: document.getElementById('editRestaurantOwner').value,
                contactNumber: document.getElementById('editRestaurantContact').value,
                address: document.getElementById('editRestaurantAddress').value
            };

            try {
                if (restoId) {
                    await setDoc(doc(db, "restaurants", restoId), restoData, { merge: true });
                    showToast('Restaurant updated successfully!');
                } else {
                    await addDoc(collection(db, "restaurants"), restoData);
                    showToast('Restaurant added successfully!');
                }
                closeRestaurantEditModal();
            } catch(error) {
                console.error("Error saving restaurant: ", error);
                showToast("Failed to save restaurant. Please check connection.", 'error');
            }
        }

        function openDeleteRestaurantConfirmModal(restoId) {
            const resto = localRestaurants.find(r => r.id === restoId);
            if (!resto) return;

            const modal = document.getElementById('delete-restaurant-confirm-modal');
            document.getElementById('delete-restaurant-name').textContent = resto.name;
            document.getElementById('confirm-delete-restaurant-btn').onclick = () => deleteRestaurant(restoId);
            modal.classList.remove('hidden');
        }

        function closeDeleteRestaurantConfirmModal() {
            document.getElementById('delete-restaurant-confirm-modal').classList.add('hidden');
        }

        async function deleteRestaurant(restoId) {
            try {
                // Note: Deleting subcollections is more complex and requires a cloud function for production.
                // This client-side delete is for demonstration purposes.
                await deleteDoc(doc(db, "restaurants", restoId));
                // Also delete users associated with this restaurant
                const usersToDelete = localUsers.filter(u => u.restaurantId === restoId);
                const batch = writeBatch(db);
                usersToDelete.forEach(user => {
                    batch.delete(doc(db, "users", user.id));
                });
                await batch.commit();
                
                closeDeleteRestaurantConfirmModal();
                showToast('Restaurant deleted successfully!');
            } catch(error) {
                console.error("Error deleting restaurant:", error);
                showToast("Failed to delete restaurant.", 'error');
            }
        }
        
        async function saveMenuItem(e) {
            e.preventDefault();
            const itemId = document.getElementById('editItemId').value;
            const itemData = {
                name: document.getElementById('editItemName').value,
                description: document.getElementById('editItemDesc').value,
                prepTime: parseInt(document.getElementById('editItemPrepTime').value),
                price: parseInt(document.getElementById('editItemPrice').value),
                image: document.getElementById('editItemImage').value,
                tags: {} // Simplified for now
            };

            if (!currentRestaurantId) {
                showToast("No restaurant selected.", 'error');
                return;
            }

            try {
                if (itemId) {
                    await setDoc(doc(db, "restaurants", currentRestaurantId, "menu", itemId), itemData, { merge: true });
                } else {
                    await addDoc(collection(db, "restaurants", currentRestaurantId, "menu"), itemData);
                }
                showToast("Menu item saved successfully!");
                closeEditModal();
            } catch (error) {
                console.error("Error saving menu item:", error);
                showToast("Failed to save menu item.", 'error');
            }
        }

        // --- OTHER FUNCTIONS (need minor adjustments or are fine) ---
        // Add event listeners to forms
        document.getElementById('user-edit-form').addEventListener('submit', saveUser);
        document.getElementById('restaurant-edit-form').addEventListener('submit', saveRestaurant);
        document.getElementById('edit-item-form').addEventListener('submit', saveMenuItem);
        adminRestaurantSelector.addEventListener('change', (e) => {
            const newRestoId = e.target.value;
            if (newRestoId) {
                selectRestaurant(newRestoId);
            } else {
                adminMenuContainer.classList.add('hidden');
                adminPageActions.classList.add('hidden');
            }
        });
        
        // --- UTILITY ---
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            const bgColor = type === 'error' ? 'bg-red-500' : 'bg-green-500';
            toast.className = `fixed bottom-5 right-5 ${bgColor} text-white py-2 px-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.classList.remove('translate-y-20', 'opacity-0');
            }, 100);
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- INITIALIZATION ---
        function startApp() {
            loginPage.classList.add('hidden');
            mainAppContainer.classList.remove('hidden');
            document.body.classList.remove('items-center', 'justify-center', 'min-h-screen');
            
            setupDataListeners(); // IMPORTANT: Start listening to DB changes

            // Hide/show nav links based on role
            if (isUserAdmin) {
                document.getElementById('nav-admin').classList.remove('hidden');
                document.getElementById('nav-kot').classList.remove('hidden');
                if(!isSuperUser) { // Regular admins get their own user management tab
                    document.getElementById('nav-user-management').classList.remove('hidden');
                }
            }

            if (isSuperUser) {
                document.getElementById('nav-restaurant-management').classList.remove('hidden');
                showPage('restaurant-management-page'); // Superuser starts here
            } else if (isUserAdmin) {
                showPage('admin-page'); // Regular admin starts here
            } else { // Customer
                showPage('menu-page');
                renderFilters();
            }
        };

        // --- DATABASE SEEDING (ONE-TIME USE) ---
        async function seedDatabase() {
            const usersRef = collection(db, "users");
            const snapshot = await getDocs(usersRef);
            if (!snapshot.empty) {
                console.log("Database already seeded.");
                return;
            }

            console.log("Seeding database...");
            const batch = writeBatch(db);

            // Create Restaurants
            const resto1Ref = doc(collection(db, "restaurants"));
            batch.set(resto1Ref, { name: 'SGS Grand Restaurant', ownerName: 'Mr. Smith', contactNumber: '111-222-3333', address: '123 Gastronomy Lane' });

            const resto2Ref = doc(collection(db, "restaurants"));
            batch.set(resto2Ref, { name: 'The Corner Bistro', ownerName: 'Ms. Jones', contactNumber: '444-555-6666', address: '456 Culinary Corner' });

            // Create Users
            const superUserRef = doc(collection(db, "users"));
            batch.set(superUserRef, { email: 'superuser@tenantadmin.sgs.com', password: 'sgs123', role: 'admin', restaurantId: null });
            
            const customer1Ref = doc(collection(db, "users"));
            batch.set(customer1Ref, { email: 'customer@test.com', password: 'password', role: 'customer', restaurantId: resto1Ref.id });

            const admin1Ref = doc(collection(db, "users"));
            batch.set(admin1Ref, { email: 'admin@sgsgrand.com', password: 'password', role: 'admin', restaurantId: resto1Ref.id });
            
            const customer2Ref = doc(collection(db, "users"));
            batch.set(customer2Ref, { email: 'user@bistro.com', password: 'password', role: 'customer', restaurantId: resto2Ref.id });

            // Commit the batch
            await batch.commit();
            console.log("Database seeded successfully!");
        }

        // ONE-TIME-USE: Uncomment the line below, run the app once, then re-comment it.
        // seedDatabase(); 

        // Make some functions globally accessible from HTML onclick
        window.showPage = showPage;
        window.openRestaurantEditModal = (restoId = null) => {
            const restaurantEditForm = document.getElementById('restaurant-edit-form');
            const restaurantEditModalTitle = document.getElementById('restaurant-edit-modal-title');
            restaurantEditForm.reset();
            const isNew = restoId === null;
            restaurantEditModalTitle.textContent = isNew ? 'Add New Restaurant' : 'Edit Restaurant';
            document.getElementById('editRestaurantId').value = isNew ? '' : restoId;
            if (!isNew) {
                const resto = localRestaurants.find(r => r.id === restoId);
                if (!resto) return;
                document.getElementById('editRestaurantName').value = resto.name;
                document.getElementById('editRestaurantOwner').value = resto.ownerName || '';
                document.getElementById('editRestaurantContact').value = resto.contactNumber || '';
                document.getElementById('editRestaurantAddress').value = resto.address || '';
            }
            document.getElementById('restaurant-edit-modal').classList.remove('hidden');
        };
        window.closeRestaurantEditModal = () => document.getElementById('restaurant-edit-modal').classList.add('hidden');
        window.openUserEditModal = (userId = null) => {
            const userEditForm = document.getElementById('user-edit-form');
            const userEditModalTitle = document.getElementById('user-edit-modal-title');
            userEditForm.reset();
            const isNew = userId === null;
            userEditModalTitle.textContent = isNew ? 'Add New User' : 'Edit User';
            document.getElementById('editUserId').value = isNew ? '' : userId;
            if (!isNew) {
                const user = localUsers.find(u => u.id === userId);
                if (!user) {
                    console.error("User not found for editing:", userId);
                    showToast("Could not find user to edit.", "error");
                    return;
                };
                document.getElementById('editUserEmail').value = user.email;
                document.getElementById('editUserPassword').value = user.password;
                document.getElementById('editUserRole').value = user.role;
            }
            document.getElementById('user-edit-modal').classList.remove('hidden');
        };
        window.closeUserEditModal = () => document.getElementById('user-edit-modal').classList.add('hidden');
        window.deleteRestaurant = deleteRestaurant;
        window.deleteUser = deleteUser;
        window.openEditModal = (itemId = null) => {
            const editItemForm = document.getElementById('edit-item-form');
            const editModalTitle = document.getElementById('edit-modal-title');
            editItemForm.reset(); 
            const isNew = itemId === null; 
            editModalTitle.textContent = isNew ? 'Add New Item' : 'Edit Menu Item'; 
            document.getElementById('editItemId').value = isNew ? '' : itemId; 
            if (!isNew) { 
                const item = localMenu.find(i => i.id === itemId); 
                if (!item) return; 
                document.getElementById('editItemName').value = item.name; 
                document.getElementById('editItemDesc').value = item.description; 
                document.getElementById('editItemPrepTime').value = item.prepTime; 
                document.getElementById('editItemPrice').value = item.price; 
                document.getElementById('editItemImage').value = item.image; 
                updateImagePreview(item.image); 
            } else { 
                updateImagePreview(''); 
            } 
            document.getElementById('edit-modal').classList.remove('hidden');
        };
        window.closeEditModal = () => document.getElementById('edit-modal').classList.add('hidden');
        window.selectRestaurant = (restoId) => {
            currentRestaurantId = restoId;
            setupDataListeners();
            showPage('admin-page');
        };
        window.showAdminMenu = () => {
            const restaurant = localRestaurants.find(r => r.id === currentRestaurantId);
            adminPageTitle.textContent = restaurant ? `Menu Management for ${restaurant.name}` : 'Menu Management';
            adminMenuContainer.classList.remove('hidden');
            adminPageActions.classList.remove('hidden');
            renderAdminTable();
        };
        window.populateAdminRestaurantSelector = () => {
            adminRestaurantSelectorContainer.classList.remove('hidden');
            adminRestaurantSelector.innerHTML = '<option value="">Select a restaurant to manage...</option>';
            localRestaurants.forEach(resto => {
                const option = document.createElement('option');
                option.value = resto.id;
                option.textContent = resto.name;
                if (resto.id === currentRestaurantId) {
                    option.selected = true;
                }
                adminRestaurantSelector.appendChild(option);
            });
        };
        window.openDeleteRestaurantConfirmModal = openDeleteRestaurantConfirmModal;
        window.closeDeleteRestaurantConfirmModal = closeDeleteRestaurantConfirmModal;
        window.generateAiImage = async () => {
            const dishName = document.getElementById('editItemName').value;
            const btn = document.getElementById('ai-generate-image-btn');
            if (!dishName) { showToast("Please enter a dish name first.", 'error'); return; }
            btn.classList.add('loading');
            btn.disabled = true;
            document.getElementById('image-preview-container').classList.add('loading');
            try {
                const prompt = `A photorealistic, professional food photography shot of '${dishName}', beautifully plated on a clean white background, ready for a restaurant menu.`;
                const payload = { instances: [{ prompt: prompt }], parameters: { "sampleCount": 1 } };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();
                if (result.predictions && result.predictions[0].bytesBase64Encoded) {
                    const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                    document.getElementById('editItemImage').value = imageUrl;
                    updateImagePreview(imageUrl);
                } else { throw new Error("No image generated."); }
            } catch (error) {
                showToast("Failed to generate image.", 'error');
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
                document.getElementById('image-preview-container').classList.remove('loading');
            }
        };
        window.generateAiDescription = async () => {
            const dishName = document.getElementById('editItemName').value;
            const btn = document.getElementById('ai-generate-desc-btn');
            if (!dishName) { showToast("Please enter a dish name first.", 'error'); return; }
            btn.classList.add('loading');
            btn.disabled = true;
            try {
                const prompt = `Generate a short, appetizing menu description for a dish called '${dishName}'. Keep it under 20 words.`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();
                if (result.candidates && result.candidates[0].content.parts[0].text) {
                    document.getElementById('editItemDesc').value = result.candidates[0].content.parts[0].text.trim();
                } else { throw new Error("No description generated."); }
            } catch (error) {
                showToast("Failed to generate description.", 'error');
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        };
        window.handleImageUpload = (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageUrl = e.target.result;
                    document.getElementById('editItemImage').value = imageUrl;
                    updateImagePreview(imageUrl);
                };
                reader.readAsDataURL(file);
            }
        };
        function updateImagePreview(src) {
            const imagePreview = document.getElementById('image-preview');
            const imagePlaceholder = document.getElementById('image-placeholder');
            if (src) {
                imagePreview.src = src;
                imagePreview.classList.remove('hidden');
                imagePlaceholder.classList.add('hidden');
            } else {
                imagePreview.classList.add('hidden');
                imagePlaceholder.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>
