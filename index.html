<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style for sortable table headers */
        .sortable-header {
            cursor: pointer;
            position: relative;
        }
        .sortable-header::after, .sortable-header::before {
            content: '';
            display: block;
            position: absolute;
            right: 10px;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            opacity: 0.3;
        }
        .sortable-header::before {
            border-bottom: 5px solid #6b7280;
            top: 50%;
            margin-top: -7px;
        }
        .sortable-header::after {
            border-top: 5px solid #6b7280;
            top: 50%;
            margin-top: 1px;
        }
        .sortable-header.asc::before {
            opacity: 1;
        }
        .sortable-header.desc::after {
            opacity: 1;
        }
        /* Custom dropdown arrow */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='lucide lucide-chevron-down'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1em;
            padding-right: 2.5rem;
        }
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-sm">

    <!-- Login Screen -->
    <div id="login-screen" class="flex items-center justify-center h-screen bg-gray-800">
        <div class="w-full max-w-md p-8 space-y-8 bg-white rounded-lg shadow-md">
            <div class="text-center">
                 <div class="flex items-center justify-center text-2xl font-bold text-gray-800 mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-utensils-crossed mr-2"><path d="m16 2-2.3 2.3a3 3 0 0 0 0 4.2l1.8 1.8a3 3 0 0 0 4.2 0L22 8Z"/><path d="M15 15 3.3 3.3a4.2 4.2 0 0 0 0 6l7.3 7.3c.7.7 2 .7 2.8 0L15 15Z"/><path d="m2.1 2.1 6.4 6.4"/><path d="m19 5-7 7"/></svg>
                    <span>DineEase</span>
                </div>
                <p class="text-gray-500">Welcome back! Please login to your account.</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="email" class="text-sm font-medium text-gray-700">Email address</label>
                    <input id="email" name="email" type="email" autocomplete="email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="you@example.com">
                </div>
                <div>
                    <label for="password" class="text-sm font-medium text-gray-700">Password</label>
                    <input id="password" name="password" type="password" autocomplete="current-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="••••••••">
                </div>
                <div>
                    <button id="login-button" type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gray-800 hover:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-900">
                        Login
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- Main Dashboard -->
    <div id="dashboard-screen" class="h-screen hidden">
        <!-- Sidebar -->
        <aside class="w-56 bg-gray-800 text-white flex-shrink-0 hidden md:flex md:flex-col">
            <div class="h-16 flex items-center justify-center text-xl font-bold">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-utensils-crossed mr-2"><path d="m16 2-2.3 2.3a3 3 0 0 0 0 4.2l1.8 1.8a3 3 0 0 0 4.2 0L22 8Z"/><path d="M15 15 3.3 3.3a4.2 4.2 0 0 0 0 6l7.3 7.3c.7.7 2 .7 2.8 0L15 15Z"/><path d="m2.1 2.1 6.4 6.4"/><path d="m19 5-7 7"/></svg>
                <span>DineEase</span>
            </div>
            <nav id="sidebar-nav" class="flex-1 px-4 py-6 space-y-2">
                <a href="#" class="flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md" data-target="dashboard-content">
                    <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i>
                    Dashboard
                </a>
                <a href="#" class="flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md" data-target="menu-content">
                    <i data-lucide="menu" class="w-5 h-5 mr-3"></i>
                    Menu
                </a>
                <a href="#" class="flex items-center px-4 py-2 bg-gray-900 text-white rounded-md" data-target="restaurant-management-content">
                    <i data-lucide="store" class="w-5 h-5 mr-3"></i>
                    Restaurants
                </a>
                 <a href="#" class="flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md" data-target="user-management-content">
                    <i data-lucide="users" class="w-5 h-5 mr-3"></i>
                    User Management
                </a>
            </nav>
        </aside>

        <!-- Main content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="bg-white border-b border-gray-200">
                <div class="flex items-center justify-between h-16 px-4 md:px-8">
                    <div class="flex items-center">
                         <button id="menu-button" class="md:hidden mr-4 text-gray-600">
                            <i data-lucide="menu" class="w-6 h-6"></i>
                        </button>
                        <h1 id="header-title" class="text-lg font-semibold text-gray-800">Restaurant Management</h1>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="relative">
                            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                            <input type="text" id="searchInput" placeholder="Search" class="pl-9 pr-4 py-1.5 w-40 md:w-56 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-xs">
                        </div>
                        
                        <!-- Action Buttons Container -->
                        <div id="restaurant-actions" class="items-center space-x-3 hidden sm:flex">
                            <button id="add-restaurant-btn" class="bg-gray-900 text-white px-3 py-1.5 rounded-md hover:bg-gray-800 text-xs">Add Restaurant</button>
                        </div>
                         <div id="menu-actions" class="items-center space-x-3 hidden sm:flex">
                             <select id="menuRestaurantFilter" class="block w-full pl-3 pr-10 py-1.5 text-xs border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md">
                                <option value="">Select Restaurant</option>
                            </select>
                            <button id="add-menu-item-btn" class="bg-gray-900 text-white px-3 py-1.5 rounded-md hover:bg-gray-800 text-xs whitespace-nowrap">Add Item</button>
                            <button id="delete-selected-menu-items-btn" class="bg-red-600 text-white px-3 py-1.5 rounded-md hover:bg-red-700 text-xs whitespace-nowrap hidden">Delete Selected</button>
                        </div>
                        <div id="user-actions" class="items-center space-x-3 hidden sm:flex">
                             <select id="restaurantFilter" class="block w-full pl-3 pr-10 py-1.5 text-xs border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md">
                                <option value="all">All Restaurants</option>
                            </select>
                            <button id="add-user-btn" class="bg-gray-900 text-white px-3 py-1.5 rounded-md hover:bg-gray-800 text-xs whitespace-nowrap">Add User</button>
                             <button id="delete-selected-users-btn" class="bg-red-600 text-white px-3 py-1.5 rounded-md hover:bg-red-700 text-xs whitespace-nowrap hidden">Delete Selected</button>
                        </div>
                        
                         <div class="relative">
                           <button class="w-9 h-9 bg-blue-500 text-white rounded-full flex items-center justify-center text-base font-semibold">U</button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Mobile Sidebar -->
            <div id="mobile-menu" class="md:hidden bg-gray-800 text-white fixed inset-0 z-50 transform -translate-x-full transition-transform duration-300 ease-in-out">
                <div class="flex justify-between items-center p-4 border-b border-gray-700">
                     <div class="h-16 flex items-center text-xl font-bold">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-utensils-crossed mr-2"><path d="m16 2-2.3 2.3a3 3 0 0 0 0 4.2l1.8 1.8a3 3 0 0 0 4.2 0L22 8Z"/><path d="M15 15 3.3 3.3a4.2 4.2 0 0 0 0 6l7.3 7.3c.7.7 2 .7 2.8 0L15 15Z"/><path d="m2.1 2.1 6.4 6.4"/><path d="m19 5-7 7"/></svg>
                        <span>DineEase</span>
                    </div>
                    <button id="close-menu-button" class="text-white">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <nav id="mobile-nav" class="flex-1 px-4 py-6 space-y-2">
                    <a href="#" class="flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md" data-target="dashboard-content">
                        <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i>
                        Dashboard
                    </a>
                    <a href="#" class="flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md" data-target="menu-content">
                        <i data-lucide="menu" class="w-5 h-5 mr-3"></i>
                        Menu
                    </a>
                    <a href="#" class="flex items-center px-4 py-2 bg-gray-900 text-white rounded-md" data-target="restaurant-management-content">
                        <i data-lucide="store" class="w-5 h-5 mr-3"></i>
                        Restaurants
                    </a>
                     <a href="#" class="flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md" data-target="user-management-content">
                        <i data-lucide="users" class="w-5 h-5 mr-3"></i>
                        User Management
                    </a>
                </nav>
            </div>

            <!-- Restaurant Table -->
            <main id="restaurant-management-content" class="flex-1 overflow-x-auto overflow-y-auto bg-white p-4 md:p-8">
                <div class="min-w-full inline-block align-middle">
                    <div class="overflow-hidden border rounded-lg">
                        <table id="restaurantTable" class="min-w-full divide-y divide-gray-200">
                             <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-column-index="0">Name</th>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-column-index="1">Owner</th>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-column-index="2">Contact</th>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-column-index="3">Address</th>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-column-index="4">Onboarding Date</th>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-column-index="5">Plan Type</th>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-column-index="6">Last Payment</th>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </main>

            <!-- Menu Table -->
            <main id="menu-content" class="flex-1 overflow-x-auto overflow-y-auto bg-white p-4 md:p-8 hidden">
                 <div class="min-w-full inline-block align-middle">
                    <div class="overflow-hidden border rounded-lg">
                        <table id="menuTable" class="min-w-full divide-y divide-gray-200">
                             <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="p-4"><input type="checkbox" id="select-all-menu-items" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded"></th>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-column-index="1">Name</th>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-column-index="2">Category</th>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-column-index="3">Price</th>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-column-index="4">Time to Prep.</th>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </main>

            <!-- User Management Table -->
            <main id="user-management-content" class="flex-1 overflow-x-auto overflow-y-auto bg-white p-4 md:p-8 hidden">
                <div class="min-w-full inline-block align-middle">
                    <div class="overflow-hidden border rounded-lg">
                        <table id="userTable" class="min-w-full divide-y divide-gray-200">
                           <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="p-4"><input type="checkbox" id="select-all-users" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded"></th>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-column-index="1">Name</th>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-column-index="2">Email</th>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-column-index="3">Restaurant</th>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-column-index="4">Status</th>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-column-index="5">Role</th>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-column-index="6">Last log in</th>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
        
        <!-- Help Button -->
        <div class="fixed bottom-8 right-8">
            <button class="w-12 h-12 bg-gray-900 text-white rounded-full flex items-center justify-center shadow-lg">
                <i data-lucide="help-circle" class="w-6 h-6"></i>
            </button>
        </div>
    </div>

    <!-- Add/Edit Restaurant Modal -->
    <div id="restaurant-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 id="modal-title" class="text-lg font-semibold">Add Restaurant</h3>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form id="restaurant-form" class="space-y-4">
                <input type="hidden" id="res-id">
                <div>
                    <label for="res-name" class="block text-xs font-medium text-gray-700">Name</label>
                    <input type="text" id="res-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                 <div class="relative">
                    <label for="res-owner-search" class="block text-xs font-medium text-gray-700">Owner</label>
                    <input type="text" id="res-owner-search" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" autocomplete="off">
                    <div id="owner-dropdown" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md mt-1 max-h-40 overflow-y-auto hidden"></div>
                </div>
                <div>
                    <label for="res-contact" class="block text-xs font-medium text-gray-700">Contact</label>
                    <input type="text" id="res-contact" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="res-address" class="block text-xs font-medium text-gray-700">Address</label>
                    <input type="text" id="res-address" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="res-onboarding" class="block text-xs font-medium text-gray-700">Onboarding Date</label>
                        <input type="date" id="res-onboarding" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="res-plan" class="block text-xs font-medium text-gray-700">Plan Type</label>
                        <select id="res-plan" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option>Basic</option>
                            <option>Premium</option>
                        </select>
                    </div>
                </div>
                 <div>
                    <label for="res-payment" class="block text-xs font-medium text-gray-700">Last Payment ($)</label>
                    <input type="number" step="0.01" id="res-payment" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div class="flex justify-end pt-4 space-x-2 border-t mt-4">
                    <button type="button" id="cancel-modal-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-gray-800 text-white rounded-md hover:bg-gray-900">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div id="user-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 id="user-modal-title" class="text-lg font-semibold">Add User</h3>
                <button id="close-user-modal-btn" class="text-gray-500 hover:text-gray-800">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form id="user-form" class="space-y-4">
                 <input type="hidden" id="user-id">
                <div>
                    <label for="user-name" class="block text-xs font-medium text-gray-700">Name</label>
                    <input type="text" id="user-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="user-email" class="block text-xs font-medium text-gray-700">Email</label>
                    <input type="email" id="user-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                
                <!-- Multi-select restaurant dropdown -->
                <div class="relative">
                    <label class="block text-xs font-medium text-gray-700">Restaurants</label>
                    <div class="mt-1 flex flex-wrap gap-2 p-2 border border-gray-300 rounded-md" id="multi-select-container">
                        <input type="text" id="restaurant-search-input" class="flex-grow focus:outline-none" placeholder="Select restaurants...">
                    </div>
                    <div id="restaurant-dropdown" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md mt-1 max-h-40 overflow-y-auto hidden"></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="user-status" class="block text-xs font-medium text-gray-700">Status</label>
                        <select id="user-status" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option>Active</option>
                            <option>Inactive</option>
                        </select>
                    </div>
                    <div>
                        <label for="user-role" class="block text-xs font-medium text-gray-700">Role</label>
                        <select id="user-role" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option>Admin</option>
                            <option>User</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end pt-4 space-x-2 border-t mt-4">
                    <button type="button" id="cancel-user-modal-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-gray-800 text-white rounded-md hover:bg-gray-900">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Menu Item Modal -->
    <div id="menu-item-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-3xl">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 id="menu-item-modal-title" class="text-lg font-semibold">Add Menu Item</h3>
                <button id="close-menu-item-modal-btn" class="text-gray-500 hover:text-gray-800">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form id="menu-item-form" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                <input type="hidden" id="menu-item-id">
                <input type="hidden" id="menu-item-restaurant-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Left Column -->
                    <div class="space-y-4">
                        <div>
                            <label for="item-name" class="block text-xs font-medium text-gray-700">Name <span class="text-red-500">*</span></label>
                            <input type="text" id="item-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <div class="flex justify-between items-center">
                                <label for="item-description" class="block text-xs font-medium text-gray-700">Description</label>
                            </div>
                            <textarea id="item-description" rows="4" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                             <button type="button" id="generate-description-btn" class="mt-2 flex items-center justify-center gap-2 text-xs text-white px-3 py-1.5 rounded-md bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700">
                                <i data-lucide="sparkles" class="w-4 h-4"></i> Generate with AI
                            </button>
                        </div>
                         <div>
                            <label for="item-category" class="block text-xs font-medium text-gray-700">Category <span class="text-red-500">*</span></label>
                            <select id="item-category" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <option>Starter</option>
                                <option>Main Course</option>
                                <option>Dessert</option>
                                <option>Beverage</option>
                            </select>
                        </div>
                        <div>
                            <label for="item-cuisine" class="block text-xs font-medium text-gray-700">Cuisine</label>
                            <select id="item-cuisine" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <option>American</option>
                                <option>Italian</option>
                                <option>Mexican</option>
                                <option>Japanese</option>
                                <option>Chinese</option>
                                <option>Indian</option>
                                <option>Thai</option>
                                <option>French</option>
                                <option>Spanish</option>
                                <option>Greek</option>
                                <option>Mediterranean</option>
                                <option>Lebanese</option>
                                <option>Vietnamese</option>
                                <option>Korean</option>
                                <option>Other</option>
                            </select>
                        </div>
                        <div>
                            <label for="item-taste" class="block text-xs font-medium text-gray-700">Taste</label>
                            <select id="item-taste" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <option>Sweet</option>
                                <option>Creamy</option>
                                <option>Mild Spicy</option>
                                <option>Medium Spicy</option>
                                <option>Super Spicy</option>
                            </select>
                        </div>
                    </div>
                    <!-- Right Column -->
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-700">Image</label>
                            <div id="image-preview-container" class="mt-1 h-40 w-full bg-gray-100 rounded flex items-center justify-center border-2 border-dashed">
                                <img id="item-image-preview" src="" class="max-h-full max-w-full hidden object-contain">
                                <div id="image-loader" class="loader hidden"></div>
                                <span id="image-placeholder" class="text-gray-400 text-xs">Image Preview</span>
                            </div>
                             <input type="file" id="item-image-upload" class="hidden" accept="image/*">
                             <input type="hidden" id="item-image-url">
                            <div class="flex gap-2 mt-2">
                                <button type="button" id="upload-image-btn" class="flex-1 text-xs bg-white border border-gray-300 px-3 py-1.5 rounded-md hover:bg-gray-50">Upload</button>
                                <button type="button" id="generate-image-btn" class="flex-1 flex items-center justify-center gap-2 text-xs text-white px-3 py-1.5 rounded-md bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700">
                                    <i data-lucide="sparkles" class="w-4 h-4"></i> Generate
                                </button>
                            </div>
                        </div>
                        <div>
                            <label for="item-price" class="block text-xs font-medium text-gray-700">Price ($) <span class="text-red-500">*</span></label>
                            <input type="number" step="0.01" id="item-price" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="item-prep-time" class="block text-xs font-medium text-gray-700">Time to Preparation (mins) <span class="text-red-500">*</span></label>
                            <input type="number" id="item-prep-time" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                             <label class="block text-xs font-medium text-gray-700">Portion Size</label>
                             <div class="mt-2 flex flex-wrap gap-x-4 gap-y-2">
                                <label class="inline-flex items-center"><input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded" value="Mini"> <span class="ml-2">Mini</span></label>
                                <label class="inline-flex items-center"><input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded" value="Small"> <span class="ml-2">Small</span></label>
                                <label class="inline-flex items-center"><input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded" value="Medium"> <span class="ml-2">Medium</span></label>
                                <label class="inline-flex items-center"><input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded" value="Large"> <span class="ml-2">Large</span></label>
                                <label class="inline-flex items-center"><input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded" value="Extra Large"> <span class="ml-2">Extra Large</span></label>
                             </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end pt-4 space-x-2 border-t mt-4">
                    <button type="button" id="cancel-menu-item-modal-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-gray-800 text-white rounded-md hover:bg-gray-900">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 id="confirm-title" class="text-lg font-semibold">Confirm Deletion</h3>
            <p id="confirm-message" class="text-sm text-gray-600 mt-2 mb-4">Are you sure?</p>
            <div id="confirm-input-container" class="hidden">
                 <label for="confirm-input" class="block text-xs font-medium text-gray-700">Please type "Delete" to confirm.</label>
                 <input type="text" id="confirm-input" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm">
            </div>
            <div class="flex justify-end pt-4 space-x-2 mt-4">
                <button type="button" id="cancel-confirm-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                <button type="button" id="confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-red-300">Confirm</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- FIREBASE CONFIG ---
        // IMPORTANT: Replace with your actual Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCBGMJzHbwD3Y95fwRKVgdYU2KBQ7oDYHQ",
            authDomain: "dineeasy-8176e.firebaseapp.com",
            projectId: "dineeasy-8176e",
            storageBucket: "dineeasy-8176e.firebasestorage.app",
            messagingSenderId: "811985378716",
            appId: "1:811985378716:web:26c599db464c67a537bc59",
            measurementId: "G-0F0ERHYX32"
        };


        // --- INITIALIZE FIREBASE ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DATA STORE ---
        let restaurantData = [];
        let userData = [];
        let menuData = [];

        // --- ELEMENTS ---
        const loginScreen = document.getElementById('login-screen');
        const dashboardScreen = document.getElementById('dashboard-screen');
        const loginForm = document.getElementById('login-form');
        const menuButton = document.getElementById('menu-button');
        const closeMenuButton = document.getElementById('close-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const searchInput = document.getElementById('searchInput');
        const restaurantTableBody = document.querySelector('#restaurantTable tbody');
        const menuTableBody = document.querySelector('#menuTable tbody');
        const userTableBody = document.querySelector('#userTable tbody');
        const navLinks = document.querySelectorAll('#sidebar-nav a, #mobile-nav a');
        const contentSections = document.querySelectorAll('main');
        const headerTitle = document.getElementById('header-title');
        const restaurantActions = document.getElementById('restaurant-actions');
        const menuActions = document.getElementById('menu-actions');
        const userActions = document.getElementById('user-actions');
        const restaurantFilter = document.getElementById('restaurantFilter');
        const menuRestaurantFilter = document.getElementById('menuRestaurantFilter');
        let currentView = 'restaurant-management-content';

        // Restaurant Modal elements
        const restaurantModal = document.getElementById('restaurant-modal');
        const modalTitle = document.getElementById('modal-title');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const cancelModalBtn = document.getElementById('cancel-modal-btn');
        const restaurantForm = document.getElementById('restaurant-form');
        const addRestaurantBtn = document.getElementById('add-restaurant-btn');
        const ownerSearchInput = document.getElementById('res-owner-search');
        const ownerDropdown = document.getElementById('owner-dropdown');
        
        // User Modal elements
        const userModal = document.getElementById('user-modal');
        const userModalTitle = document.getElementById('user-modal-title');
        const closeUserModalBtn = document.getElementById('close-user-modal-btn');
        const cancelUserModalBtn = document.getElementById('cancel-user-modal-btn');
        const userForm = document.getElementById('user-form');
        const addUserBtn = document.getElementById('add-user-btn');
        const multiSelectContainer = document.getElementById('multi-select-container');
        const restaurantSearchInput = document.getElementById('restaurant-search-input');
        const restaurantDropdown = document.getElementById('restaurant-dropdown');

        // Menu Item Modal elements
        const menuItemModal = document.getElementById('menu-item-modal');
        const menuItemModalTitle = document.getElementById('menu-item-modal-title');
        const closeMenuItemModalBtn = document.getElementById('close-menu-item-modal-btn');
        const cancelMenuItemModalBtn = document.getElementById('cancel-menu-item-modal-btn');
        const menuItemForm = document.getElementById('menu-item-form');
        const addMenuItemBtn = document.getElementById('add-menu-item-btn');
        const generateDescriptionBtn = document.getElementById('generate-description-btn');
        const generateImageBtn = document.getElementById('generate-image-btn');
        const imagePreview = document.getElementById('item-image-preview');
        const imageLoader = document.getElementById('image-loader');
        const imagePlaceholder = document.getElementById('image-placeholder');
        const uploadImageBtn = document.getElementById('upload-image-btn');
        const imageUploadInput = document.getElementById('item-image-upload');

        // Confirm Modal Elements
        const confirmModal = document.getElementById('confirm-modal');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmInputContainer = document.getElementById('confirm-input-container');
        const confirmInput = document.getElementById('confirm-input');
        const cancelConfirmBtn = document.getElementById('cancel-confirm-btn');
        let confirmBtn = document.getElementById('confirm-btn');
        

        // --- INITIALIZATION ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                loginScreen.classList.add('hidden');
                dashboardScreen.classList.remove('hidden');
                dashboardScreen.classList.add('flex');
                initializeDataListeners();
            } catch (error) {
                console.error("Firebase email/password sign-in failed:", error);
                alert("Login failed. Please check your email and password.");
            }
        });

        function initializeDataListeners() {
            onSnapshot(collection(db, "restaurants"), (snapshot) => {
                restaurantData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            });
            onSnapshot(collection(db, "users"), (snapshot) => {
                userData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            });
            onSnapshot(collection(db, "menuItems"), (snapshot) => {
                menuData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            });
        }


        // --- EVENT LISTENERS ---
        menuButton.addEventListener('click', () => mobileMenu.classList.remove('-translate-x-full'));
        closeMenuButton.addEventListener('click', () => mobileMenu.classList.add('-translate-x-full'));
        searchInput.addEventListener('keyup', handleSearch);
        restaurantFilter.addEventListener('change', () => renderUserTable());
        menuRestaurantFilter.addEventListener('change', () => renderMenuTable());

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                setupView(link.dataset.target);
                mobileMenu.classList.add('-translate-x-full');
            });
        });

        // Restaurant Modal listeners
        addRestaurantBtn.addEventListener('click', () => openRestaurantModal('add'));
        closeModalBtn.addEventListener('click', closeRestaurantModal);
        cancelModalBtn.addEventListener('click', closeRestaurantModal);
        restaurantModal.addEventListener('click', (e) => { if(e.target === restaurantModal) closeRestaurantModal(); });
        restaurantForm.addEventListener('submit', handleRestaurantFormSubmit);
        restaurantTableBody.addEventListener('click', (e) => {
            const editButton = e.target.closest('.edit-btn');
            if (editButton) openRestaurantModal('edit', editButton.closest('tr').dataset.id);
            const deleteButton = e.target.closest('.delete-btn');
            if (deleteButton) handleDeleteRestaurant(deleteButton.closest('tr').dataset.id);
        });
        ownerSearchInput.addEventListener('focus', () => ownerDropdown.classList.remove('hidden'));
        ownerSearchInput.addEventListener('blur', () => setTimeout(() => ownerDropdown.classList.add('hidden'), 150));
        ownerSearchInput.addEventListener('keyup', filterOwners);

        // User Modal Listeners
        addUserBtn.addEventListener('click', () => openUserModal('add'));
        closeUserModalBtn.addEventListener('click', closeUserModal);
        cancelUserModalBtn.addEventListener('click', closeUserModal);
        userModal.addEventListener('click', (e) => { if(e.target === userModal) closeUserModal(); });
        userForm.addEventListener('submit', handleUserFormSubmit);
        userTableBody.addEventListener('click', (e) => {
            const editButton = e.target.closest('.edit-user-btn');
            if (editButton) openUserModal('edit', editButton.closest('tr').dataset.id);
            const deleteButton = e.target.closest('.delete-user-btn');
            if (deleteButton) handleDeleteUser(deleteButton.closest('tr').dataset.id);
        });
        restaurantSearchInput.addEventListener('focus', () => restaurantDropdown.classList.remove('hidden'));
        restaurantSearchInput.addEventListener('blur', () => setTimeout(() => restaurantDropdown.classList.add('hidden'), 150));
        restaurantSearchInput.addEventListener('keyup', filterRestaurantsForDropdown);

        // Menu Item Modal Listeners
        addMenuItemBtn.addEventListener('click', () => openMenuItemModal('add'));
        closeMenuItemModalBtn.addEventListener('click', closeMenuItemModal);
        cancelMenuItemModalBtn.addEventListener('click', closeMenuItemModal);
        menuItemModal.addEventListener('click', (e) => { if(e.target === menuItemModal) closeMenuItemModal(); });
        menuItemForm.addEventListener('submit', handleMenuItemFormSubmit);
        menuTableBody.addEventListener('click', (e) => {
            const editButton = e.target.closest('.edit-menu-item-btn');
            if (editButton) openMenuItemModal('edit', editButton.closest('tr').dataset.id);
        });
        generateDescriptionBtn.addEventListener('click', handleGenerateDescription);
        generateImageBtn.addEventListener('click', handleGenerateImage);
        uploadImageBtn.addEventListener('click', () => imageUploadInput.click());
        imageUploadInput.addEventListener('change', handleImageUpload);

        // Confirm Modal Listeners
        cancelConfirmBtn.addEventListener('click', () => confirmModal.style.display = 'none');
        confirmModal.addEventListener('click', (e) => { if(e.target === confirmModal) confirmModal.style.display = 'none'; });


        // --- RENDER FUNCTIONS ---
        function renderAll() {
            renderRestaurantTable();
            renderUserTable();
            renderMenuTable();
            populateAllRestaurantFilters();
        }

        function renderRestaurantTable() {
            restaurantTableBody.innerHTML = '';
            const searchTerm = searchInput.value.toLowerCase();
            const filteredData = (currentView === 'restaurant-management-content' && searchTerm)
                ? restaurantData.filter(r => r.name.toLowerCase().includes(searchTerm) || r.owner.toLowerCase().includes(searchTerm))
                : restaurantData;

            if (restaurantData.length === 0) {
                showEmptyState(restaurantTableBody, 8, 'No restaurants found.', 'Add Restaurant', () => openRestaurantModal('add'));
            } else if (filteredData.length === 0) {
                showEmptyState(restaurantTableBody, 8, 'No results found for your search.');
            } else {
                filteredData.forEach((res, index) => {
                    const newRow = restaurantTableBody.insertRow();
                    newRow.className = index % 2 === 0 ? 'hover:bg-gray-50' : 'bg-gray-50 hover:bg-gray-100';
                    newRow.dataset.id = res.id;
                    newRow.innerHTML = `
                        <td class="px-4 py-2 whitespace-nowrap text-xs font-medium text-gray-900">${res.name}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-xs text-blue-500 font-medium underline">${res.owner}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-xs text-gray-500">${res.contact}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-xs text-gray-500">${res.address}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-xs text-gray-500">${res.onboarding}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-xs"><span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${res.plan === 'Premium' ? 'bg-blue-100 text-blue-800' : 'bg-gray-200 text-gray-800'}">${res.plan}</span></td>
                        <td class="px-4 py-2 whitespace-nowrap text-xs text-gray-500">$${res.payment}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-xs text-gray-500 flex items-center space-x-2">
                            <button class="edit-btn"><i data-lucide="edit-2" class="w-5 h-5"></i></button> 
                            <button class="delete-btn"><i data-lucide="trash-2" class="w-5 h-5 text-red-500"></i></button>
                        </td>
                    `;
                });
            }
            lucide.createIcons();
        }
         
        function renderMenuTable() {
            menuTableBody.innerHTML = '';
            const selectedRestaurantId = menuRestaurantFilter.value;
            if (!selectedRestaurantId) {
                showEmptyState(menuTableBody, 6, 'Please select a restaurant to see its menu.');
                return;
            }

            const searchTerm = searchInput.value.toLowerCase();
            const filteredData = menuData.filter(item => {
                const restaurantMatch = item.restaurantId === selectedRestaurantId;
                const searchMatch = (currentView === 'menu-content' && searchTerm)
                    ? item.name.toLowerCase().includes(searchTerm) || item.category.toLowerCase().includes(searchTerm)
                    : true;
                return restaurantMatch && searchMatch;
            });

            if (filteredData.length === 0 && !searchTerm) {
                showEmptyState(menuTableBody, 6, 'No menu items for this restaurant yet.', 'Add Item', () => openMenuItemModal('add'));
            } else if (filteredData.length === 0) {
                showEmptyState(menuTableBody, 6, 'No results found for your search.');
            } else {
                filteredData.forEach((item, index) => {
                    const newRow = menuTableBody.insertRow();
                    newRow.className = index % 2 === 0 ? 'hover:bg-gray-50' : 'bg-gray-50 hover:bg-gray-100';
                    newRow.dataset.id = item.id;
                    newRow.innerHTML = `
                        <td class="p-4"><input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded menu-item-checkbox" data-id="${item.id}"></td>
                        <td class="px-4 py-2 whitespace-nowrap text-xs font-medium text-gray-900">${item.name}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-xs text-gray-500">${item.category}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-xs text-gray-500">$${item.price}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-xs text-gray-500">${item.prepTime} mins</td>
                        <td class="px-4 py-2 whitespace-nowrap text-xs text-gray-500 flex items-center space-x-2">
                            <button class="edit-menu-item-btn"><i data-lucide="edit-2" class="w-5 h-5"></i></button> 
                            <button class="delete-menu-item-btn"><i data-lucide="trash-2" class="w-5 h-5 text-red-500"></i></button>
                        </td>
                    `;
                });
            }
             lucide.createIcons();
        }

        function renderUserTable() {
            userTableBody.innerHTML = '';
            const searchTerm = searchInput.value.toLowerCase();
            const selectedRestaurant = restaurantFilter.value;
            
            const filteredData = userData.filter(user => {
                const searchMatch = (currentView === 'user-management-content' && searchTerm)
                    ? user.name.toLowerCase().includes(searchTerm) || user.email.toLowerCase().includes(searchTerm)
                    : true;
                const filterMatch = selectedRestaurant === 'all' || user.restaurants.includes(selectedRestaurant);
                return searchMatch && filterMatch;
            });

            if (userData.length === 0) {
                showEmptyState(userTableBody, 8, 'No users found.', 'Add User', () => openUserModal('add'));
            } else if (filteredData.length === 0) {
                 showEmptyState(userTableBody, 8, 'No results found for your search or filter.');
            } else {
                filteredData.forEach((user, index) => {
                    const newRow = userTableBody.insertRow();
                    newRow.className = index % 2 === 0 ? 'hover:bg-gray-50' : 'bg-gray-50 hover:bg-gray-100';
                    newRow.dataset.id = user.id;
                    const restaurantHTML = user.restaurants.map(r => `<span class="px-2 py-0.5 bg-gray-200 text-gray-800 rounded-full text-xs">${r}</span>`).join('');
                    newRow.innerHTML = `
                        <td class="p-4"><input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded user-checkbox" data-id="${user.id}"></td>
                        <td class="px-4 py-2 whitespace-nowrap text-xs font-medium text-gray-900">${user.name}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-xs text-gray-500">${user.email}</td>
                        <td class="px-4 py-2 text-xs text-gray-500"><div class="flex flex-wrap gap-1">${restaurantHTML}</div></td>
                        <td class="px-4 py-2 whitespace-nowrap text-xs"><span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${user.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${user.status}</span></td>
                        <td class="px-4 py-2 whitespace-nowrap text-xs text-gray-500">${user.role}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-xs text-gray-500">${user.lastLogin}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-xs text-gray-500 flex items-center space-x-2">
                            <button class="edit-user-btn"><i data-lucide="edit-2" class="w-5 h-5"></i></button> 
                            <button class="delete-user-btn"><i data-lucide="trash-2" class="w-5 h-5 text-red-500"></i></button>
                        </td>
                    `;
                });
            }
            lucide.createIcons();
        }

        function showEmptyState(tbody, colspan, message, buttonText = null, buttonAction = null) {
            const row = tbody.insertRow();
            const cell = row.insertCell();
            cell.colSpan = colspan;
            cell.className = 'text-center py-12';
            
            let buttonHtml = '';
            if (buttonText && buttonAction) {
                buttonHtml = `<button id="empty-state-btn" class="mt-4 bg-gray-900 text-white px-3 py-1.5 rounded-md hover:bg-gray-800 text-xs">${buttonText}</button>`;
            }

            cell.innerHTML = `
                <div class="text-center">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2z" />
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">${message}</h3>
                    ${buttonHtml}
                </div>
            `;
            
            if (buttonAction) {
                cell.querySelector('#empty-state-btn').addEventListener('click', buttonAction);
            }
        }

        // --- GENERAL FUNCTIONS ---
        function setupView(targetId) {
            currentView = targetId;
            contentSections.forEach(section => section.classList.add('hidden'));
            const targetSection = document.getElementById(targetId);
            if (targetSection) targetSection.classList.remove('hidden');

            restaurantActions.style.display = 'none';
            menuActions.style.display = 'none';
            userActions.style.display = 'none';

            if (targetId === 'restaurant-management-content') {
                headerTitle.textContent = 'Restaurant Management';
                restaurantActions.style.display = 'flex';
            } else if (targetId === 'menu-content') {
                headerTitle.textContent = 'Menu Management';
                menuActions.style.display = 'flex';
            } else if (targetId === 'user-management-content') {
                headerTitle.textContent = 'User Management';
                userActions.style.display = 'flex';
            } else {
                 headerTitle.textContent = 'Dashboard';
            }

            document.querySelectorAll('#sidebar-nav a, #mobile-nav a').forEach(nav => {
                nav.classList.remove('bg-gray-900', 'text-white');
                nav.classList.add('text-gray-300');
                if (nav.dataset.target === targetId) {
                    nav.classList.add('bg-gray-900', 'text-white');
                    nav.classList.remove('text-gray-300');
                }
            });
            handleSearch(); // Re-filter on view change
        }

        function handleSearch() {
            if (currentView === 'restaurant-management-content') {
                renderRestaurantTable();
            } else if (currentView === 'user-management-content') {
                renderUserTable();
            } else if (currentView === 'menu-content') {
                renderMenuTable();
            }
        }

        function populateAllRestaurantFilters() {
            const restaurantNames = new Set(restaurantData.map(r => r.name));
            
            // For user management filter
            const existingUserFilterOptions = restaurantFilter.querySelectorAll('option:not([value="all"])');
            existingUserFilterOptions.forEach(opt => opt.remove());
            restaurantNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                restaurantFilter.appendChild(option);
            });

            // For menu management filter
            const existingMenuFilterOptions = menuRestaurantFilter.querySelectorAll('option:not([value=""])');
            existingMenuFilterOptions.forEach(opt => opt.remove());
            restaurantData.forEach(res => {
                const option = document.createElement('option');
                option.value = res.id;
                option.textContent = res.name;
                menuRestaurantFilter.appendChild(option);
            });
        }

        // --- RESTAURANT MODAL ---
        function openRestaurantModal(mode, id = null) {
            restaurantForm.reset();
            populateOwnerDropdown();
            if (mode === 'add') {
                modalTitle.textContent = 'Add Restaurant';
                document.getElementById('res-id').value = '';
            } else if (mode === 'edit' && id) {
                modalTitle.textContent = 'Edit Restaurant';
                const res = restaurantData.find(r => r.id === id);
                if(res) {
                    document.getElementById('res-id').value = res.id;
                    document.getElementById('res-name').value = res.name;
                    document.getElementById('res-owner-search').value = res.owner;
                    document.getElementById('res-contact').value = res.contact;
                    document.getElementById('res-address').value = res.address;
                    document.getElementById('res-onboarding').value = res.onboarding;
                    document.getElementById('res-plan').value = res.plan;
                    document.getElementById('res-payment').value = res.payment;
                }
            }
            restaurantModal.style.display = 'flex';
            lucide.createIcons();
        }

        function closeRestaurantModal() {
            restaurantModal.style.display = 'none';
        }

        async function handleRestaurantFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('res-id').value;
            const formData = {
                name: document.getElementById('res-name').value,
                owner: document.getElementById('res-owner-search').value,
                contact: document.getElementById('res-contact').value,
                address: document.getElementById('res-address').value,
                onboarding: document.getElementById('res-onboarding').value,
                plan: document.getElementById('res-plan').value,
                payment: parseFloat(document.getElementById('res-payment').value).toFixed(2)
            };

            if (id) {
                await updateDoc(doc(db, "restaurants", id), formData);
            } else {
                await addDoc(collection(db, "restaurants"), formData);
            }
            closeRestaurantModal();
        }

        function populateOwnerDropdown() {
            ownerDropdown.innerHTML = '';
            const userNames = new Set(userData.map(u => u.name));
            userNames.forEach(name => {
                const optionDiv = document.createElement('div');
                optionDiv.textContent = name;
                optionDiv.className = 'px-3 py-2 cursor-pointer hover:bg-gray-100';
                optionDiv.addEventListener('mousedown', () => {
                    ownerSearchInput.value = name;
                    ownerDropdown.classList.add('hidden');
                });
                ownerDropdown.appendChild(optionDiv);
            });
        }

        function filterOwners() {
            const filter = ownerSearchInput.value.toLowerCase();
            const options = ownerDropdown.getElementsByTagName('div');
            for (let i = 0; i < options.length; i++) {
                if (options[i].textContent.toLowerCase().includes(filter)) {
                    options[i].style.display = "";
                } else {
                    options[i].style.display = "none";
                }
            }
        }

         // --- USER MODAL ---
        function openUserModal(mode, id = null) {
            userForm.reset();
            clearMultiSelect();
            if (mode === 'add') {
                userModalTitle.textContent = 'Add User';
                document.getElementById('user-id').value = '';
            } else if (mode === 'edit' && id) {
                userModalTitle.textContent = 'Edit User';
                const user = userData.find(u => u.id === id);
                if (user) {
                    document.getElementById('user-id').value = user.id;
                    document.getElementById('user-name').value = user.name;
                    document.getElementById('user-email').value = user.email;
                    user.restaurants.forEach(addRestaurantToMultiSelect);
                    document.getElementById('user-status').value = user.status;
                    document.getElementById('user-role').value = user.role;
                }
            }
            populateRestaurantDropdown();
            userModal.style.display = 'flex';
            lucide.createIcons();
        }

        function closeUserModal() {
            userModal.style.display = 'none';
        }

        async function handleUserFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('user-id').value;
            const selectedRestaurants = Array.from(multiSelectContainer.querySelectorAll('.multi-select-pill')).map(pill => pill.dataset.value);
            const formData = {
                name: document.getElementById('user-name').value,
                email: document.getElementById('user-email').value,
                restaurants: selectedRestaurants,
                status: document.getElementById('user-status').value,
                role: document.getElementById('user-role').value,
                lastLogin: 'Just now'
            };
            
            if (id) {
                await updateDoc(doc(db, "users", id), formData);
            } else {
                await addDoc(collection(db, "users"), formData);
            }
            closeUserModal();
        }

        // Multi-select functions
        function populateRestaurantDropdown() {
            restaurantDropdown.innerHTML = '';
            const selected = getSelectedRestaurants();
            const available = restaurantData.map(r => r.name).filter(r => !selected.includes(r));
            
            available.forEach(name => {
                const optionDiv = document.createElement('div');
                optionDiv.textContent = name;
                optionDiv.className = 'px-3 py-2 cursor-pointer hover:bg-gray-100';
                optionDiv.addEventListener('mousedown', () => {
                    addRestaurantToMultiSelect(name);
                    populateRestaurantDropdown();
                });
                restaurantDropdown.appendChild(optionDiv);
            });
        }
        
        function addRestaurantToMultiSelect(name) {
            const pill = document.createElement('span');
            pill.className = 'multi-select-pill flex items-center bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full';
            pill.dataset.value = name;
            pill.innerHTML = `
                ${name}
                <button type="button" class="ml-1.5 -mr-1 flex-shrink-0 inline-flex items-center justify-center h-4 w-4 rounded-full text-blue-400 hover:bg-blue-200 hover:text-blue-500 focus:outline-none focus:bg-blue-500 focus:text-white">
                    <i data-lucide="x" class="h-3 w-3"></i>
                </button>
            `;
            pill.querySelector('button').addEventListener('click', () => {
                pill.remove();
                populateRestaurantDropdown();
            });
            multiSelectContainer.insertBefore(pill, restaurantSearchInput);
            lucide.createIcons({nodes: [pill]});
        }

        function getSelectedRestaurants() {
            return Array.from(multiSelectContainer.querySelectorAll('.multi-select-pill')).map(pill => pill.dataset.value);
        }

        function clearMultiSelect() {
            multiSelectContainer.querySelectorAll('.multi-select-pill').forEach(pill => pill.remove());
            restaurantSearchInput.value = '';
        }

        function filterRestaurantsForDropdown() {
            const filter = restaurantSearchInput.value.toLowerCase();
            const options = restaurantDropdown.getElementsByTagName('div');
            for (let i = 0; i < options.length; i++) {
                if (options[i].textContent.toLowerCase().includes(filter)) {
                    options[i].style.display = "";
                } else {
                    options[i].style.display = "none";
                }
            }
        }

        // --- MENU ITEM MODAL ---
        function openMenuItemModal(mode, id = null) {
            menuItemForm.reset();
            imagePreview.src = '';
            imagePreview.classList.add('hidden');
            imagePlaceholder.classList.remove('hidden');

            if (mode === 'add') {
                menuItemModalTitle.textContent = 'Add Menu Item';
                document.getElementById('menu-item-id').value = '';
            } else if (mode === 'edit' && id) {
                menuItemModalTitle.textContent = 'Edit Menu Item';
                const item = menuData.find(i => i.id === id);
                if (item) {
                    document.getElementById('menu-item-id').value = item.id;
                    document.getElementById('item-name').value = item.name;
                    document.getElementById('item-description').value = item.description;
                    document.getElementById('item-image-url').value = item.imageUrl;
                    if(item.imageUrl) {
                        imagePreview.src = item.imageUrl;
                        imagePreview.classList.remove('hidden');
                        imagePlaceholder.classList.add('hidden');
                    }
                    document.getElementById('item-price').value = item.price;
                    document.getElementById('item-cuisine').value = item.cuisine;
                    document.getElementById('item-taste').value = item.taste;
                    document.getElementById('item-category').value = item.category;
                    document.getElementById('item-prep-time').value = item.prepTime;
                    
                    const checkboxes = menuItemForm.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(cb => {
                        cb.checked = item.portionSizes.includes(cb.value);
                    });
                }
            }
            menuItemModal.style.display = 'flex';
            lucide.createIcons();
        }

        function closeMenuItemModal() {
            menuItemModal.style.display = 'none';
        }

        async function handleMenuItemFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('menu-item-id').value;
            const selectedPortions = Array.from(menuItemForm.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
            const formData = {
                restaurantId: menuRestaurantFilter.value,
                name: document.getElementById('item-name').value,
                description: document.getElementById('item-description').value,
                imageUrl: document.getElementById('item-image-url').value,
                price: parseFloat(document.getElementById('item-price').value).toFixed(2),
                cuisine: document.getElementById('item-cuisine').value,
                taste: document.getElementById('item-taste').value,
                category: document.getElementById('item-category').value,
                prepTime: document.getElementById('item-prep-time').value,
                portionSizes: selectedPortions
            };

            if (id) {
                await updateDoc(doc(db, "menuItems", id), formData);
            } else {
                await addDoc(collection(db, "menuItems"), formData);
            }
            closeMenuItemModal();
        }
        
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('item-image-url').value = e.target.result;
                    imagePreview.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                    imagePlaceholder.classList.add('hidden');
                }
                reader.readAsDataURL(file);
            }
        }

        // --- DELETION & CONFIRMATION ---
        function openConfirmModal({ title, message, requiresInput, onConfirm }) {
            confirmTitle.textContent = title;
            confirmMessage.textContent = message;
            confirmInput.value = '';

            if (requiresInput) {
                confirmInputContainer.style.display = 'block';
                confirmBtn.disabled = true;
                confirmInput.onkeyup = () => {
                    confirmBtn.disabled = confirmInput.value !== 'Delete';
                };
            } else {
                confirmInputContainer.style.display = 'none';
                confirmBtn.disabled = false;
            }

            confirmModal.style.display = 'flex';

            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            newConfirmBtn.addEventListener('click', () => {
                onConfirm();
                confirmModal.style.display = 'none';
            });
            confirmBtn = newConfirmBtn;
        }

        async function handleDeleteRestaurant(id) {
            const restaurant = restaurantData.find(r => r.id === id);
            openConfirmModal({
                title: `Delete ${restaurant.name}`,
                message: `This action cannot be undone. This will permanently delete the restaurant.`,
                requiresInput: true,
                onConfirm: async () => {
                    await deleteDoc(doc(db, "restaurants", id));
                }
            });
        }

        async function handleDeleteUser(id) {
            const user = userData.find(u => u.id === id);
            openConfirmModal({
                title: `Delete ${user.name}`,
                message: `Are you sure you want to delete this user? This action cannot be undone.`,
                requiresInput: false,
                onConfirm: async () => {
                    await deleteDoc(doc(db, "users", id));
                }
            });
        }

        // --- AI FUNCTIONS ---
        async function handleGenerateDescription(e) {
            const btn = e.target;
            btn.disabled = true;
            btn.innerHTML = '<div class="loader"></div>';

            const prompt = `Generate a short, impactful menu description under 100 characters for a dish with these details. Do not use any markdown formatting:
            - Name: ${document.getElementById('item-name').value}
            - Category: ${document.getElementById('item-category').value}
            - Cuisine: ${document.getElementById('item-cuisine').value}
            - Taste Profile: ${document.getElementById('item-taste').value}
            - Price: $${document.getElementById('item-price').value}`;
            
            try {
                const response = await fetch('/api/generateDescription', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });
                const result = await response.json();
                document.getElementById('item-description').value = result.text.trim().replace(/\*/g, '');
            } catch (error) {
                console.error("Error generating description:", error);
                alert("Failed to generate description.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="sparkles" class="w-4 h-4"></i> Generate with AI';
                lucide.createIcons();
            }
        }

        async function handleGenerateImage(e) {
            const btn = e.target;
            btn.disabled = true;
            btn.innerHTML = '<div class="loader"></div>';
            imageLoader.classList.remove('hidden');
            imagePreview.classList.add('hidden');
            imagePlaceholder.classList.add('hidden');

            const prompt = `Professional, vibrant food photography of a dish named "${document.getElementById('item-name').value}". It is a ${document.getElementById('item-cuisine').value} ${document.getElementById('item-category').value} with a ${document.getElementById('item-taste').value} taste profile. The dish should look delicious and be presented on a clean, modern plate.`;

            try {
                const response = await fetch('/api/generateImage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });
                const result = await response.json();
                if (result.imageUrl) {
                    document.getElementById('item-image-url').value = result.imageUrl;
                    imagePreview.src = result.imageUrl;
                    imagePreview.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error generating image:", error);
                alert("Failed to generate image.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="sparkles" class="w-4 h-4"></i> Generate';
                lucide.createIcons();
                imageLoader.classList.add('hidden');
            }
        }

    </script>
</body>
</html>
